# 三國天命放置小遊戲 - Godot PRD + 視圖設計

## 1. 專案簡介
- **名稱**：三國天命放置小遊戲
- **平台**：Godot Engine 4.x (多平台：Steam, Web, iOS, Android)
- **主要目標平台**：移動端 (手機直立畫面)
- **題材**：三國歷史 + 放置養成  
- **玩法特色**：
  - 自動化放置遊戲，開局設定後自動進行。
  - 技能與星星資源的選擇影響遊戲進程。
  - 核心循環：隨機事件 → 攻城戰 → 收編 → 升級 → 重複。
  - 以簡化 UI + 事件動畫演出為主，地圖和戰鬥畫面由 Godot Scene 控制。
  - **畫面風格** 像素風格 (重要!)

---

## 2. Godot 系統架構

### 2.1 高層場景結構
- `Main_Mobile.tscn` (移動端優化主場景，414x896解析度)
  - `TopBar` (Control, VBoxContainer) → 玩家資訊與資源顯示
    - `PlayerInfo` → 玩家頭像、名稱、等級、回合、年份
    - `AbilityStats` → 兩行能力值顯示 (武力/智力/統治 & 政治/魅力/天命)
    - `Resources` → 金錢/兵數/城池數顯示
  - `GameMainArea` (HSplitContainer) → 主遊戲區域分割
    - `MapArea` (Node2D) → 城池地圖、路線顯示
    - `GameEvent` (ScrollContainer + VBoxContainer) → 遊戲事件日誌
  - `BottomBar` (TabContainer) → 武將/武技/政略/國家/裝備/更多
  - `BattleScene` (Node2D, 預設隱藏) → 戰鬥演出

### 2.2 資料與邏輯分離
- `GameManager.gd`：遊戲主迴圈 (遊戲事件、戰鬥、升級)
- `DataLoader.gd`：載入技能 / 將領 / 城池 / 隨機事件資料 (JSON)
- `BattleManager.gd`：處理戰鬥模擬與結果
- `MapManager.gd`：繪製城池節點與路線，管理可攻擊目標
- `Main.gd`：UI更新控制 (TopBar, GameMainArea, BottomBar)
- `SaveManager.gd`：存檔 / 載入進度 (Godot File API)
- `GameLogger.gd`：除錯日誌系統 (與遊戲事件分離)
- `VisualEffects.gd`：視覺效果與動畫系統

### 2.3 重要術語區分
- **Game Events (遊戲事件)**：玩家可見的遊戲進程事件，顯示在GameEvent中
  - 使用 `game_events` 變量、`add_game_event()` 方法
- **Debug Logs (除錯日誌)**：開發者除錯用的系統日誌，寫入檔案
  - 使用 `logger` 變量、`logger.info()` 等方法

---

## 3. 視圖設計 (參考 UI 樣式)

### 3.1 移動端畫面結構 (414x896)
```
+------------------------------------------------------+
| 玩家資訊欄 (TopBar 180px 高度)                       |
| PlayerInfo: 頭像 + 名稱/等級/回合/年份 (HBox)        |
| AbilityRow1: 武力/智力/統治 (HBox)                   |
| AbilityRow2: 政治/魅力/天命 (HBox)                   |
| Resources: 金錢/兵數/城池數 (HBox)                   |
+------------------------------------------------------+

+------------------------------------------------------------------+
| 遊戲主畫面 (GameMainArea HSplitContainer)                        |
| +---------------------------+----------------------------------+ |
| | MapArea (Node2D)          | GameEvent (ScrollContainer)       | |
| | - 三國城池節點與連線      | - 遊戲事件日誌 (18px字體)       | |
| | - 城池狀態顏色區分        | - 自動滾動到最新事件             | |
| | - 點擊城池顯示詳細資訊    | - 事件分類顯示 (戰鬥/普通等)     | |
| | - CitiesContainer         | - GameEventContent (VBox)        | |
| | - ConnectionsContainer    |                                  | |
| +---------------------------+----------------------------------+ |
| 戰鬥時：BattleScene 覆蓋整個 GameMainArea                        |
+------------------------------------------------------------------+

+------------------------------------------------------+
| 功能導航列 (BottomBar TabContainer 120px高度)        |
| [武將] [武技] [政略] [國家] [裝備] [更多]             |
| - 武將：GeneralsList (VBoxContainer)                |
| - 武技：SkillsList (VBoxContainer)                  |
| - 政略：PoliticsContent (VBoxContainer)             |
| - 國家：NationContent (VBoxContainer)               |
| - 裝備：EquipmentContent (VBoxContainer)            |
| - 更多：SaveButton/LoadButton/SettingsButton        |
+------------------------------------------------------+
```

### 3.2 Godot 移動端對應設計
- **(TopBar)**
  - 節點：`Control` → `VBoxContainer`
  - PlayerInfo: `HBoxContainer` (頭像 + 玩家詳細資訊)
  - AbilityStats: `VBoxContainer` → AbilityRow1/AbilityRow2 `HBoxContainer`
  - Resources: `HBoxContainer` (金錢/兵數/城池數)  

- **(MapArea)**  
  - 節點：`Node2D`  
  - 子節點：`CityNode.tscn` (每座城池)  
  - 顯示三國城池 (以 Circle + Label)
  - `Line2D` 畫城池間路線  
  - 點擊城池 → `CityDetailPanel` (Control) 彈窗顯示  
  - 可攻擊目標節點加上 Pulse 動畫 (Tween)

- **(GameEvent)**
  - 節點型態：ScrollContainer + VBoxContainer + Label陣列
  - 行為：
    - 顯示遊戲事件 (非除錯日誌)
    - 18px字體大小 (手機可讀性)
    - 自動滾動到最新事件
    - 支援顏色標記 (普通事件 / 戰鬥 / 特殊)
    - 與除錯日誌系統完全分離

- **(BattleScene)**
  - 節點型態：Node2D
  - 行為：
    - 戰鬥開始時切換顯示
    - 顯示簡單的單位對衝動畫 (兵力減少、技能特效)
    - 結束後顯示結果彈窗，返回地圖模式

- **(BottomBar)**  
  - 節點：`Control` → `HBoxContainer`  
  - 6 個 Button/IconButton，對應功能系統  
  - 點擊後切換對應 UI Scene  

---

## 4. 遊戲邏輯

### 4.1 資料結構 (JSON → Godot Dictionary)

**請幫忙補充**



### 4.2 遊戲流程

#### 4.2.1 開局
1. 玩家獲得 **10 顆星星**。
2. 系統從 **天命技能資料庫** (40+ 技能) 中隨機抽取 3 個技能。
   - 玩家可選擇 **1 個技能** 或 **不選**。
   - 技能需要消耗 1~3 星星。
3. 重複三輪技能抽選。
4. 剩餘的星星轉換為 **能力值點數**：
   - 1 星星 = 10 能力值
   - 隨機分配到 **武力、智力、統治、政治、魅力** (玩家可手動分配是進階選項)。

#### 4.2.2 能力值 (0~100)
- **武力**：攻擊傷害基礎值。
- **智力**：技能成功率與技能傷害。
- **統治**：帶兵數量與承受傷害上限。
- **政治**：城池產資源量、守城成功率。
- **魅力**：俘虜將領的投降率 & 將領自動投奔的機率。
- **天命 (隱藏)**：隨機事件發生機率加乘、隱藏 buff。

#### 4.2.3 升級系統
- 玩家等級：Lv.1 ~ Lv.10。
- 戰鬥勝利 → 玩家等級 +1。
- 升級時隨機增加能力值 (0~10)。


### 4.3 遊戲主循環
1. **隨機事件階段**
   - 從事件資料庫 (50+ 事件) 抽取 1~2 個事件。
   - 機率受 **天命** 影響。
2. **戰鬥階段**
   - 攻打相鄰城池 (隨機選擇)。
   - 結果依據 **能力值 + 技能 + 裝備**。
   - 勝利 → 獲得俘虜 → 根據 **魅力** 決定是否收編。
3. **收編/資源管理**
   - 新將領分配兵數。
   - 根據城池數量產生金錢 & 裝備。
4. **升級**
   - 戰鬥勝利 → 升級，增加能力值。
5. **重複流程，直到遊戲結束**。

### 4.4 結束條件
- 玩家將領死亡 → Game Over。
- 玩家統一所有城池 → Victory。

### 4.5 儲存系統
- 存檔：`user://savegame.json`
- 內容：玩家狀態、城池佔領情況、將領資料、裝備清單


### 4.6 遊戲核心規則

#### 4.6.1 資源產出機制
- **城池為資源基礎**：城池是金錢與兵力的主要來源
- **數量影響產出**：控制的城池越多，資源產出越高
- **線性成長模式**：每座城池提供固定的基礎產出值

#### 4.6.2 金錢系統規則
- **產出來源**：每座城池每回合產生固定金錢（受政治能力影響）
- **主要用途**：購買裝備、強化武器防具
- **解鎖機制**：
  - 1-2 城池：僅能購買普通裝備
  - 3-4 城池：解鎖稀有裝備購買權限
  - 5+ 城池：解鎖最高級稀有裝備
  - 傳說裝備：僅能通過特殊事件獲得，無法購買

#### 4.6.3 兵力分配規則
- **產出來源**：每座城池每回合提供固定兵力補充
- **分配機制**：
  - 玩家主將：優先分配，影響承受攻擊總量
  - 同伴將領：依據統治能力決定可分配上限
  - 城池守備：剩餘兵力用於城池防禦
- **戰鬥消耗**：每次戰鬥根據勝負結果消耗一定比例兵力

#### 4.6.4 城池管理規則
- **攻城條件**：只能攻打與現有城池相鄰的目標城池
- **防禦機制**：城池具有基礎防禦值，駐守將領提供額外防禦
- **維護成本**：城池越多，每回合維護金錢消耗越高（平衡機制）



### 4.7 遊戲資源

#### 4.7.1 技能資料庫
- 數量：40+
- 範例：
  - **火攻** (2星)：對敵方造成額外傷害。
  - **天選之人** (3星)：全能力 +2，天命 +10。
  - **堅守不出** (1星)：防守戰時傷害減半。

#### 4.7.2 城池
- 數量：16
- 下列城池 

京都(金色格子) 洛陽 - 東漢及曹魏的政治中心，天下之樞 

魏國重要城池(藍色格子) 
鄴城 - 曹操根據地，魏國政治軍事重鎮 
許昌 - 曹操挾天子以令諸侯的據點 
晉陽 - 北方軍事要塞，防禦匈奴關鍵 
薊城 - 幽州治所，北方邊防重鎮 
長安 - 西北重鎮，古都長安 

蜀國重要城池(綠色格子) 
成都 - 蜀漢國都，天府之國核心 
漢中 - 北伐前線基地，戰略要地 
街亭 - 諸葛亮北伐重要據點 
永安 - 劉備托孤之地，白帝城 
建寧 - 南中重鎮，諸葛亮南征據點 

吳國重要城池(深紅格子) 
建業 - 東吳國都，今日南京 
合肥 - 與魏國對峙的前線要塞 
柴桑 - 周瑜督軍之地，赤壁戰略基地 
會稽 - 江南政治經濟中心 
長沙 - 荊州重要據點，兵家必爭之地

- 每座城池：
  - 所屬勢力
  - 駐守將領 (1~3 名)
  - 連線路徑 (graph 結構)

#### 4.7.3 將領
- 數量：40+
- **來源**：三國史實人物庫 (曹操、劉備、孫權、關羽、張飛、諸葛亮等)。
- **屬性**：能力值 (武/智/統/政/魅)，等級。
- **狀態**：敵對 / 中立 / 玩家陣營。

#### 4.7.4 裝備
- 數量：40+
- 武器有分等級:傳說，稀有，普通，傳說武器只有事件能取得
- 稀有，普通武器根據擁有的城池數量會從低階慢慢增加高階 (例如5座城池後開始出現稀有)
- 範例：
  - 青龍偃月刀：武力 +20 傳說
  - 青罡劍：武力 +5，智力 +10 稀有
  - 赤兔馬：行軍速度 +10% (攻城時機率先手) 傳說
  - 木劍：武力 +1 普通

### 4.8 隨機事件系統
- 數量：50+
- 事件具有 **觸發機率** 與 **天命修正值**。
- 範例：
  - **天降神兵**：獲得傳說武器，機率 3%。
  - **遭受攻擊**：隨機城池失守，受政治影響。
  - **黃巾起義**：隨機新敵軍出現，增加挑戰性。
  - **賢才投奔**：隨機史實將領加入，受魅力影響。

---

## 5. 技術細節

### 5.1 移動端優化
- **解析度**：414x896 (iPhone 11 比例) 適合手機直立畫面
- **觸控支援**：啟用 touch input 與 mouse emulation
- **UI適配**：使用 VBoxContainer/HBoxContainer 響應式佈局
- **字體大小**：事件日誌使用 18px 確保手機可讀性

### 5.2 視覺效果系統 (VisualEffects.gd)
- **按鈕效果**：按下縮放 + 顏色變化動畫
- **技能選擇**：發光效果 + 淡入淡出
- **數值動畫**：數字漸變 + 顏色反饋 (綠色增加/紅色減少)
- **面板過渡**：滑入滑出動畫 (4方向支援)
- **粒子效果**：星星爆發、浮動文字
- **特殊效果**：屏幕震動、脈動、顏色漸變

### 5.3 架構改進
- **動畫**：Tween 系統控制所有視覺效果，自動清理防止記憶體洩漏
- **UI 響應式**：完全基於 Container 的移動端優先設計
- **資源載入**：JSON 數據載入 + 性能監控
- **隨機性**：RandomNumberGenerator + 天命屬性加權
- **日誌分離**：遊戲事件與除錯日誌完全分離的雙系統架構  

---
